package edf.recon

import edf.dataload._
import edf.utilities.Holder
import org.apache.spark.sql.functions.{col, lit, when}
import org.apache.spark.sql.{SaveMode, SparkSession}
import org.joda.time.format.DateTimeFormat

object gwbcRecon {
  def gwbcRecon(src_sstm_cd: String)
             (implicit spark: SparkSession) = {

    val pv_endDateQuery = s"select pv_enddate from " + s"$transformDB" + s".vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE'"
    val pv_endDateValue = spark.sql(pv_endDateQuery).collect.mkString.replaceAll("[\\[\\]]", "")
    val pv_startDateQuery = s"select pv_startdate from " + s"$transformDB" + s".vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE'"
    val pv_startDateValue = spark.sql(pv_startDateQuery).collect.mkString.replaceAll("[\\[\\]]", "")
    val load_cycle_id_query = s"select load_cycle_id from " + s"$transformDB" + s".vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE'"
    val load_cycle_id_value = spark.sql(load_cycle_id_query).collect.mkString.replaceAll("[\\[\\]]", "")
    spark.conf.set("spark.sql.crossJoin.enabled", "true")
    spark.conf.set("hive.strict.checks.cartesian.product", "false")
    spark.conf.set("hive.mapred.mode", "nonstrict")

    val srcQuery = s"(  SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_INV_ITM_CNT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, count(distinct invitem.PublicID) as auditresult  , cast(LOAD_CYCLE_ID as bigint) as etl_load_cycle_id FROM dbo.bc_invoiceitem invitem join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE (invitem.UpdateTime <= PV_ENDDATE OR invitem.CreateTime <= PV_ENDDATE ) group by LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_INV_ITM_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, sum(invitem.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_invoiceitem invitem join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID,cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE (invitem.UpdateTime <= PV_ENDDATE OR invitem.CreateTime <= PV_ENDDATE ) GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_CHRG_CNT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, count(distinct chrg.PublicID) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_charge chrg join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE chrg.CreateTime <= PV_ENDDATE   group by LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_CHRG_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(chrg.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_charge chrg join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE chrg.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_DIST_ITM_CNT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, count(distinct distitem.PublicID) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_basedistitem distitem join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE OR distitem.CreateTime <= PV_ENDDATE ) group by LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_GROSS_APPLY_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(distitem.GrossAmountToApply) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_basedistitem distitem join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_COMM_APPLY_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(distitem.CommissionAmountToApply) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_basedistitem distitem join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE  OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_DIST_CNT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, count(distinct basedist.PublicID) as auditresult  , lc.LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_basedist basedist join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 LEFT JOIN ( SELECT DISTINCT  ISNULL(ActiveDistID , ReversedDistID ) as  DistID,lc1.LOAD_CYCLE_ID 		,MAX(CAST(CASE WHEN distitem.CreateTime > PV_STARTDATE AND distitem.CreateTime <= PV_ENDDATE 			THEN distitem.CreateTime ELSE distitem.UpdateTime END AS datetime2)) AS distitem_ROW_PROC_DTS 			FROM dbo.bc_basedistitem distitem 			join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc1 on 1=1 			WHERE (distitem.UpdateTime  > PV_STARTDATE 				  AND distitem.UpdateTime <= PV_ENDDATE) 				  OR (distitem.CreateTime > PV_STARTDATE 					  AND distitem.CreateTime <= PV_ENDDATE) 			GROUP BY ISNULL(ActiveDistID , ReversedDistID ) ,lc1.LOAD_CYCLE_ID 		) disitem  ON disitem.DistID = basedist.ID and disitem.LOAD_CYCLE_ID = LC.LOAD_CYCLE_ID WHERE ((basedist.UpdateTime <= PV_ENDDATE  OR basedist.CreateTime <= PV_ENDDATE )   		OR distitem_ROW_PROC_DTS <= PV_ENDDATE) group by lc.LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_DIST_WO_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(basedist.WriteOffAmount) as auditresult  , lc.LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_basedist basedist  join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1  LEFT JOIN ( SELECT DISTINCT  ISNULL(ActiveDistID , ReversedDistID ) as  DistID,lc1.LOAD_CYCLE_ID 		,MAX(CAST(CASE WHEN distitem.CreateTime > PV_STARTDATE AND distitem.CreateTime <= PV_ENDDATE 			THEN distitem.CreateTime ELSE distitem.UpdateTime END AS datetime2)) AS distitem_ROW_PROC_DTS 			FROM dbo.bc_basedistitem distitem 			join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc1 on 1=1 			WHERE (distitem.UpdateTime  > PV_STARTDATE 				  AND distitem.UpdateTime <= PV_ENDDATE) 				  OR (distitem.CreateTime > PV_STARTDATE 					  AND distitem.CreateTime <= PV_ENDDATE) 			GROUP BY ISNULL(ActiveDistID , ReversedDistID ) ,lc1.LOAD_CYCLE_ID 		) disitem  ON disitem.DistID = basedist.ID and disitem.LOAD_CYCLE_ID = LC.LOAD_CYCLE_ID WHERE ((basedist.UpdateTime <= PV_ENDDATE  OR basedist.CreateTime <= PV_ENDDATE )   		OR distitem_ROW_PROC_DTS <= PV_ENDDATE) GROUP BY lc.LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_WO_CNT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, count(distinct wo.PublicID) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_writeoff wo join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE wo.CreateTime <= PV_ENDDATE group by LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM  UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_REVERSED_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(wo.ReversedAmount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_writeoff wo  join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE wo.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_WO_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(wo.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_writeoff wo  join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE wo.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'MTD_BILL_CHRG_TRANS_AMT' as auditentity, DATEADD(mm, DATEDIFF(mm, 0, CAST(pv_enddate as DATE) ), 0) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_chargeinstancecontext cix join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID  JOIN  dbo.bc_charge chrg ON chrg.ID = cix.ChargeID   JOIN  dbo.bc_TAccountContainer TAC ON TAC.ID = chrg.TAccountContainerID   JOIN  dbo.bctl_TAccountContainer TC ON TC.ID = TAC.Subtype   LEFT JOIN  dbo.bc_policyperiod polper     ON (polper.HiddenTAccountContainerID = chrg.TAccountContainerID 	   AND TC.TYPECODE = 'PolTAcctContainer')   LEFT JOIN  dbo.bc_policy pol ON pol.ID = polper.PolicyID AND pol.PCPublicID IS  NOT NULL   LEFT JOIN  dbo.bc_account a ON a.ID = pol.AccountID    LEFT JOIN  dbo.bc_account ta      ON  (ta.HiddenTAccountContainerID = chrg.TAccountContainerID 		  AND TC.TYPECODE = 'AcctTAcctContainer') WHERE CONVERT(varchar(6), trans.TransactionDate, 112) = CONVERT(varchar(6), PV_ENDDATE, 112) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'YTD_BILL_CHRG_TRANS_AMT' as auditentity, cast(cast(YEAR(PV_ENDDATE) as varchar)+'-01-01' as datetime2) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_chargeinstancecontext cix join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID  JOIN  dbo.bc_charge chrg ON chrg.ID = cix.ChargeID   JOIN  dbo.bc_TAccountContainer TAC ON TAC.ID = chrg.TAccountContainerID   JOIN  dbo.bctl_TAccountContainer TC ON TC.ID = TAC.Subtype   LEFT JOIN  dbo.bc_policyperiod polper     ON (polper.HiddenTAccountContainerID = chrg.TAccountContainerID 	   AND TC.TYPECODE = 'PolTAcctContainer')   LEFT JOIN  dbo.bc_policy pol ON pol.ID = polper.PolicyID AND pol.PCPublicID IS  NOT NULL   LEFT JOIN  dbo.bc_account a ON a.ID = pol.AccountID    LEFT JOIN  dbo.bc_account ta      ON  (ta.HiddenTAccountContainerID = chrg.TAccountContainerID 		  AND TC.TYPECODE = 'AcctTAcctContainer') WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_NWO_CNT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, COUNT(DISTINCT nwo.PublicID) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_negativewriteoff nwo join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE nwo.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_NWO_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(nwo.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_negativewriteoff nwo join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE nwo.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_DISB_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(disb.Amount) as auditresult , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_disbursement disb join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE disb.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_FUND_TRANFR_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(ft.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_fundsTransfer ft join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE  ft.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_BILL_NONRECV_DIST_ITM_CNT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, COUNT(distinct distitem.PublicID) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_basenonrecdistitem distitem  join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE  OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY  LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_GROSS_NONRECV_APPLY_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(distitem.GrossAmountToApply) as auditresult , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_basenonrecdistitem distitem join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE  OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY  LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'TOTAL_COMM_NONRECV_APPLY_AMT' as auditentity, '1900-01-01 00:00:00' as auditfrom, PV_ENDDATE  as auditthru, SUM(distitem.CommissionAmountToApply) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_basenonrecdistitem distitem join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE  OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'MTD_BILL_PROD_TRANS_AMT' as auditentity, DATEADD(mm, DATEDIFF(mm, 0, CAST(pv_enddate as DATE) ), 0) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_producercontext px join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = px.TransactionID LEFT JOIN  dbo.bc_chargecommission comm ON comm.ID = px.ChargeCommissionID LEFT JOIN  dbo.bc_charge chrg ON chrg.ID = comm.ChargeID LEFT JOIN  dbo.bc_policyperiod polper ON polper.HiddenTAccountContainerID = chrg.TAccountContainerID LEFT JOIN  dbo.bc_policy pol ON pol.ID = polper.PolicyID  AND pol.PCPublicID IS  NOT NULL LEFT JOIN  dbo.bc_account a ON a.ID = pol.AccountID  where CONVERT(varchar(6), trans.TransactionDate, 112) = CONVERT(varchar(6), PV_ENDDATE, 112)  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'YTD_BILL_PROD_TRANS_AMT' as auditentity, cast(cast(YEAR(PV_ENDDATE) as varchar)+'-01-01' as datetime2) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_producercontext px  join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = px.TransactionID LEFT JOIN  dbo.bc_chargecommission comm ON comm.ID = px.ChargeCommissionID LEFT JOIN  dbo.bc_charge chrg ON chrg.ID = comm.ChargeID LEFT JOIN  dbo.bc_policyperiod polper ON polper.HiddenTAccountContainerID = chrg.TAccountContainerID LEFT JOIN  dbo.bc_policy pol ON pol.ID = polper.PolicyID  AND pol.PCPublicID IS  NOT NULL LEFT JOIN  dbo.bc_account a ON a.ID = pol.AccountID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'MTD_BILL_ACCT_TRANS_AMT' as auditentity, DATEADD(mm, DATEDIFF(mm, 0, CAST(pv_enddate as DATE) ), 0) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_accountcontext cix join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID JOIN  dbo.bc_account acc ON acc.ID = cix.AccountID  where CONVERT(varchar(6), trans.TransactionDate, 112) = CONVERT(varchar(6), PV_ENDDATE, 112)  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'YTD_BILL_ACCT_TRANS_AMT' as auditentity, cast(cast(YEAR(PV_ENDDATE) as varchar)+'-01-01' as datetime2) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM dbo.bc_accountcontext cix join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID JOIN  dbo.bc_account acc ON acc.ID = cix.AccountID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'MTD_BILL_DBMR_TRANS_AMT' as auditentity, DATEADD(mm, DATEDIFF(mm, 0, CAST(pv_enddate as DATE) ), 0) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_dbmoneyrcvdcontext cix JOIN  dbo.bc_account acc ON acc.ID = cix.AccountID  LEFT JOIN  dbo.bc_basemoneyreceived bsmr ON bsmr.ID = cix.DirectBillMoneyRcvdID LEFT JOIN  dbo.bc_policyperiod polper    ON polper.ID = bsmr.PolicyPeriodID join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID  where CONVERT(varchar(6), trans.TransactionDate, 112) = CONVERT(varchar(6), PV_ENDDATE, 112)  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'YTD_BILL_DBMR_TRANS_AMT' as auditentity, cast(cast(YEAR(PV_ENDDATE) as varchar)+'-01-01' as datetime2) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_dbmoneyrcvdcontext cix    JOIN  dbo.bc_account acc ON acc.ID = cix.AccountID     LEFT JOIN  dbo.bc_basemoneyreceived bsmr ON bsmr.ID = cix.DirectBillMoneyRcvdID   LEFT JOIN  dbo.bc_policyperiod polper    ON polper.ID = bsmr.PolicyPeriodID  join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'MTD_BILL_SUSPYMT_TRANS_AMT' as auditentity, DATEADD(mm, DATEDIFF(mm, 0, CAST(pv_enddate as DATE) ), 0) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_susppymtcontext cix JOIN  dbo.bc_suspensepayment  spmt ON spmt.ID = cix.SuspensePaymentID LEFT JOIN  dbo.bc_policyperiod polper     ON polper.ID = spmt.PolicyPeriodAppliedToID  LEFT JOIN  dbo.bc_policy pol ON pol.ID = polper.PolicyID   AND pol.PCPublicID IS  NOT NULL LEFT JOIN  dbo.bc_account a ON a.ID = pol.AccountID join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID where CONVERT(varchar(6), trans.TransactionDate, 112) = CONVERT(varchar(6), PV_ENDDATE, 112)  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'YTD_BILL_SUSPYMT_TRANS_AMT' as auditentity, cast(cast(YEAR(PV_ENDDATE) as varchar)+'-01-01' as datetime2) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_susppymtcontext cix JOIN  dbo.bc_suspensepayment  spmt ON spmt.ID = cix.SuspensePaymentID LEFT JOIN  dbo.bc_policyperiod polper     ON polper.ID = spmt.PolicyPeriodAppliedToID  LEFT JOIN  dbo.bc_policy pol ON pol.ID = polper.PolicyID   AND pol.PCPublicID IS  NOT NULL LEFT JOIN  dbo.bc_account a ON a.ID = pol.AccountID join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'MTD_BILL_TRANSFR_TRANS_AMT' as auditentity, DATEADD(mm, DATEDIFF(mm, 0, CAST(pv_enddate as DATE) ), 0) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_transfertxcontext cix   LEFT JOIN  dbo.bc_account sa  ON sa.ID = cix.SourceAccountID   LEFT JOIN  dbo.bc_account ta  ON ta.ID = cix.TargetAccountID  join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID  where CONVERT(varchar(6), trans.TransactionDate, 112) = CONVERT(varchar(6), PV_ENDDATE, 112)  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'YTD_BILL_TRANSFR_TRANS_AMT' as auditentity, cast(cast(YEAR(PV_ENDDATE) as varchar)+'-01-01' as datetime2) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_transfertxcontext cix   LEFT JOIN  dbo.bc_account sa  ON sa.ID = cix.SourceAccountID   LEFT JOIN  dbo.bc_account ta  ON ta.ID = cix.TargetAccountID  join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'MTD_BILL_NONRECV_TRANS_AMT' as auditentity, DATEADD(mm, DATEDIFF(mm, 0, CAST(pv_enddate as DATE) ), 0) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_nonreceivableitemctx cix    JOIN  dbo.bc_basenonrecdistitem bndi ON bndi.ID = cix.BaseNonReceivableDistItemID    LEFT JOIN  dbo.bc_account acc ON acc.ID = cix.AccountWithSuspenseID   LEFT JOIN  dbo.bc_policyperiod polper    ON polper.ID = bndi.MatchingPolicyID  join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID  where CONVERT(varchar(6), trans.TransactionDate, 112) = CONVERT(varchar(6), PV_ENDDATE, 112)  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'YTD_BILL_NONRECV_TRANS_AMT' as auditentity, cast(cast(YEAR(PV_ENDDATE) as varchar)+'-01-01' as datetime2) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_nonreceivableitemctx cix JOIN  dbo.bc_basenonrecdistitem bndi ON bndi.ID = cix.BaseNonReceivableDistItemID LEFT JOIN  dbo.bc_account acc ON acc.ID = cix.AccountWithSuspenseID LEFT JOIN  dbo.bc_policyperiod polper    ON polper.ID = bndi.MatchingPolicyID join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'MTD_BILL_CREDIT_TRANS_AMT' as auditentity, DATEADD(mm, DATEDIFF(mm, 0, CAST(pv_enddate as DATE) ), 0) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_creditcontext cix    JOIN  dbo.bc_account acc ON acc.ID = cix.AccountID   join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID  where CONVERT(varchar(6), trans.TransactionDate, 112) = CONVERT(varchar(6), PV_ENDDATE, 112)  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM UNION SELECT PV_ENDDATE as extractdate, 'GWBC' as source_system, 'YTD_BILL_CREDIT_TRANS_AMT' as auditentity, cast(cast(YEAR(PV_ENDDATE) as varchar)+'-01-01' as datetime2) as auditfrom, PV_ENDDATE  as auditthru, SUM(trans.Amount) as auditresult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  dbo.bc_creditcontext cix    JOIN  dbo.bc_account acc ON acc.ID = cix.AccountID   join (SELECT '$load_cycle_id_value' as LOAD_CYCLE_ID, cast('$pv_startDateValue' as datetime2) as PV_STARTDATE,cast('$pv_endDateValue' as datetime2) as PV_ENDDATE, 'GWBC' AS PV_SOURCESYSTEM, '10001' AS PV_RPT_CURRENCY) lc on 1=1 JOIN  dbo.bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, PV_SOURCESYSTEM ) a"
    val lakeQuery = s"SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_BILL_INV_ITM_CNT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, count(distinct invitem.PublicID) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_invoiceitem invitem join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE (invitem.UpdateTime <= PV_ENDDATE OR invitem.CreateTime <= PV_ENDDATE ) group by LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_BILL_INV_ITM_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, sum(invitem.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_invoiceitem invitem join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE (invitem.UpdateTime <= PV_ENDDATE OR invitem.CreateTime <= PV_ENDDATE ) GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_BILL_CHRG_CNT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, count(distinct chrg.PublicID) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_charge chrg join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE chrg.CreateTime <= PV_ENDDATE   group by LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_BILL_CHRG_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(chrg.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_charge chrg join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE chrg.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_BILL_DIST_ITM_CNT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, count(distinct distitem.PublicID) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_basedistitem distitem join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE OR distitem.CreateTime <= PV_ENDDATE ) group by LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_GROSS_APPLY_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(distitem.GrossAmountToApply) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_basedistitem distitem join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_COMM_APPLY_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(distitem.CommissionAmountToApply) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_basedistitem distitem join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE  OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION  SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_BILL_DIST_CNT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, count(distinct basedist.PublicID) as AuditResult  , lc.LOAD_CYCLE_ID as  etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_basedist basedist JOIN     (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc     ON 1=1 LEFT JOIN     (SELECT COALESCE(ActiveDistID ,          ReversedDistID ) AS DistID,         lc.LOAD_CYCLE_ID ,         CASE         WHEN distitem.CreateTime > PV_STARTDATE            AND distitem.CreateTime <= PV_ENDDATE THEN         MAX(distitem.CreateTime)         ELSE MAX(distitem.UpdateTime)         END AS distitem_ROW_PROC_DTS     FROM $hiveDB.stg_gwbc_bc_basedistitem distitem     JOIN         (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc             ON 1=1         WHERE (distitem.UpdateTime > PV_STARTDATE                 AND distitem.UpdateTime <= PV_ENDDATE)                 OR (distitem.CreateTime > PV_STARTDATE                 AND distitem.CreateTime <= PV_ENDDATE)         GROUP BY  COALESCE(ActiveDistID , ReversedDistID ) ,lc.LOAD_CYCLE_ID,distitem.CreateTime,distitem.UpdateTime,lc.PV_ENDDATE,lc.PV_STARTDATE ) disitem         ON disitem.DistID = basedist.ID         AND disitem.LOAD_CYCLE_ID = LC.LOAD_CYCLE_ID WHERE ((basedist.UpdateTime <= PV_ENDDATE         OR basedist.CreateTime <= PV_ENDDATE )     OR distitem_ROW_PROC_DTS <= PV_ENDDATE) GROUP BY  lc.LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE AS extract_date,          source_system_code, 'TOTAL_BILL_DIST_WO_AMT' AS auditentity, '1900-01-01 00:00:00' AS audit_from_date, PV_ENDDATE AS audit_thru_date, SUM(basedist.WriteOffAmount) AS AuditResult , lc.LOAD_CYCLE_ID AS etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_basedist basedist JOIN     (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc     ON 1=1 LEFT JOIN     (SELECT COALESCE(ActiveDistID ,          ReversedDistID ) AS DistID,         lc.LOAD_CYCLE_ID , CASE         WHEN distitem.CreateTime > PV_STARTDATE             AND distitem.CreateTime <= PV_ENDDATE THEN         MAX(distitem.CreateTime) ELSE MAX(distitem.UpdateTime) END AS distitem_ROW_PROC_DTS     FROM $hiveDB.stg_gwbc_bc_basedistitem distitem     JOIN         (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc             ON 1=1         WHERE (distitem.UpdateTime > PV_STARTDATE                 AND distitem.UpdateTime <= PV_ENDDATE)                 OR (distitem.CreateTime > PV_STARTDATE                 AND distitem.CreateTime <= PV_ENDDATE)         GROUP BY  COALESCE(ActiveDistID , ReversedDistID ) ,lc.LOAD_CYCLE_ID,distitem.CreateTime,lc.PV_STARTDATE,lc.PV_ENDDATE ) disitem         ON disitem.DistID = basedist.ID         AND disitem.LOAD_CYCLE_ID = LC.LOAD_CYCLE_ID WHERE (basedist.UpdateTime <= PV_ENDDATE        OR basedist.CreateTime <= PV_ENDDATE )         OR distitem_ROW_PROC_DTS <= PV_ENDDATE GROUP BY lc.LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_BILL_WO_CNT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, count(distinct wo.PublicID) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_writeoff wo join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE wo.CreateTime <= PV_ENDDATE group by LOAD_CYCLE_ID, PV_ENDDATE, source_system_code  UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_REVERSED_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(wo.ReversedAmount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_writeoff wo  join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE wo.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_WO_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(wo.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_writeoff wo  join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE wo.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE AS extract_date,          'GWBC' as source_system, 'MTD_BILL_CHRG_TRANS_AMT' AS auditentity,from_unixtime(unix_timestamp(date_add(last_day(add_months(current_date, -1)),1))) AS AUDIT_FROM_DATE, PV_ENDDATE AS audit_thru_date, SUM(trans.Amount) AS AuditResult , LOAD_CYCLE_ID AS etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_chargeinstancecontext cix JOIN     (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc     ON 1=1 JOIN $hiveDB.stg_gwbc_bc_transaction trans     ON trans.ID = cix.TransactionID JOIN $hiveDB.stg_gwbc_bc_charge chrg     ON chrg.ID = cix.ChargeID JOIN $hiveDB.stg_gwbc_bc_TAccountContainer TAC     ON TAC.ID = chrg.TAccountContainerID JOIN $hiveDB.stg_gwbc_bc_taccountcontainer TC     ON TC.ID = TAC.Subtype LEFT JOIN $hiveDB.stg_gwbc_bc_policyperiod polper     ON (polper.HiddenTAccountContainerID = chrg.TAccountContainerID AND TC.bctl_taccountcontainer_typecode_subtype = 'PolTAcctContainer'        ) LEFT JOIN $hiveDB.stg_gwbc_bc_policy pol     ON pol.ID = polper.PolicyID         AND pol.PCPublicID IS NOT NULL LEFT JOIN $hiveDB.stg_gwbc_bc_account a     ON a.ID = pol.AccountID LEFT JOIN $hiveDB.stg_gwbc_bc_account ta     ON (ta.HiddenTAccountContainerID = chrg.TAccountContainerID AND TC.bctl_taccountcontainer_typecode_subtype = 'AcctTAcctContainer') WHERE replace(substring(trans.TransactionDate, 1, 7),'-','') = replace(substring(PV_ENDDATE, 1, 7),'-','')         AND trans.TransactionDate <= PV_ENDDATE GROUP BY  LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'YTD_BILL_CHRG_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 5)||'01-01 00:00:00.0000000' as string) as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_chargeinstancecontext cix JOIN     (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc     ON 1=1 JOIN $hiveDB.stg_gwbc_bc_transaction trans     ON trans.ID = cix.TransactionID JOIN $hiveDB.stg_gwbc_bc_charge chrg     ON chrg.ID = cix.ChargeID JOIN $hiveDB.stg_gwbc_bc_TAccountContainer TAC     ON TAC.ID = chrg.TAccountContainerID JOIN $hiveDB.stg_gwbc_bc_taccountcontainer TC     ON TC.ID = TAC.Subtype LEFT JOIN $hiveDB.stg_gwbc_bc_policyperiod polper     ON (polper.HiddenTAccountContainerID = chrg.TAccountContainerID         AND TC.bctl_taccountcontainer_typecode_subtype = 'PolTAcctContainer') LEFT JOIN $hiveDB.stg_gwbc_bc_policy pol     ON pol.ID = polper.PolicyID         AND pol.PCPublicID IS NOT NULL LEFT JOIN $hiveDB.stg_gwbc_bc_account a     ON a.ID = pol.AccountID LEFT JOIN $hiveDB.stg_gwbc_bc_account ta     ON (ta.HiddenTAccountContainerID = chrg.TAccountContainerID         AND TC.bctl_taccountcontainer_typecode_subtype = 'AcctTAcctContainer') WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE)         AND trans.TransactionDate <= PV_ENDDATE GROUP BY  LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_BILL_NWO_CNT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, COUNT(DISTINCT nwo.PublicID) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_negativewriteoff nwo join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE nwo.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_NWO_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(nwo.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_negativewriteoff nwo join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE nwo.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_DISB_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(disb.Amount) as AuditResult , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_disbursement disb join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE disb.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_FUND_TRANFR_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(ft.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_fundsTransfer ft join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE  ft.CreateTime <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_BILL_NONRECV_DIST_ITM_CNT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, COUNT(distinct distitem.PublicID) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_basenonrecdistitem distitem  join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE  OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY  LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_GROSS_NONRECV_APPLY_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(distitem.GrossAmountToApply) as AuditResult , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_basenonrecdistitem distitem join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE  OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY  LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'TOTAL_COMM_NONRECV_APPLY_AMT' as auditentity, '1900-01-01 00:00:00' as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(distitem.CommissionAmountToApply) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_basenonrecdistitem distitem join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 WHERE (distitem.UpdateTime <= PV_ENDDATE  OR distitem.CreateTime <= PV_ENDDATE ) GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'MTD_BILL_PROD_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 7)||'-01 00:00:00.0000000' as string) as AUDIT_FROM_DATE, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_producercontext px join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = px.TransactionID LEFT JOIN  $hiveDB.stg_gwbc_bc_chargecommission comm ON comm.ID = px.ChargeCommissionID LEFT JOIN  $hiveDB.stg_gwbc_bc_charge chrg ON chrg.ID = comm.ChargeID LEFT JOIN  $hiveDB.stg_gwbc_bc_policyperiod polper ON polper.HiddenTAccountContainerID = chrg.TAccountContainerID LEFT JOIN  $hiveDB.stg_gwbc_bc_policy pol ON pol.ID = polper.PolicyID  AND pol.PCPublicID IS  NOT NULL LEFT JOIN  $hiveDB.stg_gwbc_bc_account a ON a.ID = pol.AccountID  where replace(substring(trans.TransactionDate, 1, 7),'-','') = replace(substring(PV_ENDDATE, 1, 7),'-','')  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'YTD_BILL_PROD_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 5)||'01-01 00:00:00.0000000' as string) as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_producercontext px  join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = px.TransactionID LEFT JOIN  $hiveDB.stg_gwbc_bc_chargecommission comm ON comm.ID = px.ChargeCommissionID LEFT JOIN  $hiveDB.stg_gwbc_bc_charge chrg ON chrg.ID = comm.ChargeID LEFT JOIN  $hiveDB.stg_gwbc_bc_policyperiod polper ON polper.HiddenTAccountContainerID = chrg.TAccountContainerID LEFT JOIN  $hiveDB.stg_gwbc_bc_policy pol ON pol.ID = polper.PolicyID  AND pol.PCPublicID IS  NOT NULL LEFT JOIN  $hiveDB.stg_gwbc_bc_account a ON a.ID = pol.AccountID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'MTD_BILL_ACCT_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 7)||'-01 00:00:00.0000000' as string) as AUDIT_FROM_DATE, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_accountcontext cix join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID JOIN  $hiveDB.stg_gwbc_bc_account acc ON acc.ID = cix.AccountID  where replace(substring(trans.TransactionDate, 1, 7),'-','') = replace(substring(PV_ENDDATE, 1, 7),'-','')  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'YTD_BILL_ACCT_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 5)||'01-01 00:00:00.0000000' as string) as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM $hiveDB.stg_gwbc_bc_accountcontext cix join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID JOIN  $hiveDB.stg_gwbc_bc_account acc ON acc.ID = cix.AccountID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'MTD_BILL_DBMR_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 7)||'-01 00:00:00.0000000' as string) as AUDIT_FROM_DATE, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_dbmoneyrcvdcontext cix JOIN  $hiveDB.stg_gwbc_bc_account acc ON acc.ID = cix.AccountID  LEFT JOIN  $hiveDB.stg_gwbc_bc_basemoneyreceived bsmr ON bsmr.ID = cix.DirectBillMoneyRcvdID LEFT JOIN  $hiveDB.stg_gwbc_bc_policyperiod polper    ON polper.ID = bsmr.PolicyPeriodID join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID  where replace(substring(trans.TransactionDate, 1, 7),'-','') = replace(substring(PV_ENDDATE, 1, 7),'-','')  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'YTD_BILL_DBMR_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 5)||'01-01 00:00:00.0000000' as string) as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_dbmoneyrcvdcontext cix    JOIN  $hiveDB.stg_gwbc_bc_account acc ON acc.ID = cix.AccountID     LEFT JOIN  $hiveDB.stg_gwbc_bc_basemoneyreceived bsmr ON bsmr.ID = cix.DirectBillMoneyRcvdID   LEFT JOIN  $hiveDB.stg_gwbc_bc_policyperiod polper    ON polper.ID = bsmr.PolicyPeriodID  join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'MTD_BILL_SUSPYMT_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 7)||'-01 00:00:00.0000000' as string) as AUDIT_FROM_DATE, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_susppymtcontext cix JOIN  $hiveDB.stg_gwbc_bc_suspensepayment  spmt ON spmt.ID = cix.SuspensePaymentID LEFT JOIN  $hiveDB.stg_gwbc_bc_policyperiod polper     ON polper.ID = spmt.PolicyPeriodAppliedToID  LEFT JOIN  $hiveDB.stg_gwbc_bc_policy pol ON pol.ID = polper.PolicyID   AND pol.PCPublicID IS  NOT NULL LEFT JOIN  $hiveDB.stg_gwbc_bc_account a ON a.ID = pol.AccountID join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID where replace(substring(trans.TransactionDate, 1, 7),'-','') = replace(substring(PV_ENDDATE, 1, 7),'-','')  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'YTD_BILL_SUSPYMT_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 5)||'01-01 00:00:00.0000000' as string) as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_susppymtcontext cix JOIN  $hiveDB.stg_gwbc_bc_suspensepayment  spmt ON spmt.ID = cix.SuspensePaymentID LEFT JOIN  $hiveDB.stg_gwbc_bc_policyperiod polper     ON polper.ID = spmt.PolicyPeriodAppliedToID  LEFT JOIN  $hiveDB.stg_gwbc_bc_policy pol ON pol.ID = polper.PolicyID   AND pol.PCPublicID IS  NOT NULL LEFT JOIN  $hiveDB.stg_gwbc_bc_account a ON a.ID = pol.AccountID join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'MTD_BILL_TRANSFR_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 7)||'-01 00:00:00.0000000' as string) as AUDIT_FROM_DATE, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_transfertxcontext cix   LEFT JOIN  $hiveDB.stg_gwbc_bc_account sa  ON sa.ID = cix.SourceAccountID   LEFT JOIN  $hiveDB.stg_gwbc_bc_account ta  ON ta.ID = cix.TargetAccountID  join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID  where replace(substring(trans.TransactionDate, 1, 7),'-','') = replace(substring(PV_ENDDATE, 1, 7),'-','')  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'YTD_BILL_TRANSFR_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 5)||'01-01 00:00:00.0000000' as string) as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_transfertxcontext cix   LEFT JOIN  $hiveDB.stg_gwbc_bc_account sa  ON sa.ID = cix.SourceAccountID   LEFT JOIN  $hiveDB.stg_gwbc_bc_account ta  ON ta.ID = cix.TargetAccountID  join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'MTD_BILL_NONRECV_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 7)||'-01 00:00:00.0000000' as string) as AUDIT_FROM_DATE, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_nonreceivableitemctx cix    JOIN  $hiveDB.stg_gwbc_bc_basenonrecdistitem bndi ON bndi.ID = cix.BaseNonReceivableDistItemID    LEFT JOIN  $hiveDB.stg_gwbc_bc_account acc ON acc.ID = cix.AccountWithSuspenseID   LEFT JOIN  $hiveDB.stg_gwbc_bc_policyperiod polper    ON polper.ID = bndi.MatchingPolicyID  join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID  where replace(substring(trans.TransactionDate, 1, 7),'-','') = replace(substring(PV_ENDDATE, 1, 7),'-','')  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'YTD_BILL_NONRECV_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 5)||'01-01 00:00:00.0000000' as string) as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_nonreceivableitemctx cix JOIN  $hiveDB.stg_gwbc_bc_basenonrecdistitem bndi ON bndi.ID = cix.BaseNonReceivableDistItemID LEFT JOIN  $hiveDB.stg_gwbc_bc_account acc ON acc.ID = cix.AccountWithSuspenseID LEFT JOIN  $hiveDB.stg_gwbc_bc_policyperiod polper    ON polper.ID = bndi.MatchingPolicyID join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'MTD_BILL_CREDIT_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 7)||'-01 00:00:00.0000000' as string) as AUDIT_FROM_DATE, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_creditcontext cix    JOIN  $hiveDB.stg_gwbc_bc_account acc ON acc.ID = cix.AccountID   join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID  where replace(substring(trans.TransactionDate, 1, 7),'-','') = replace(substring(PV_ENDDATE, 1, 7),'-','')  AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code UNION SELECT PV_ENDDATE as extract_date, 'GWBC' as source_system, 'YTD_BILL_CREDIT_TRANS_AMT' as auditentity, cast(substring(pv_enddate, 1, 5)||'01-01 00:00:00.0000000' as string) as audit_from_date, PV_ENDDATE  as audit_thru_date, SUM(trans.Amount) as AuditResult  , LOAD_CYCLE_ID as etl_load_cycle_id FROM  $hiveDB.stg_gwbc_bc_creditcontext cix    JOIN  $hiveDB.stg_gwbc_bc_account acc ON acc.ID = cix.AccountID   join (SELECT  load_cycle_id,pv_startdate,pv_enddate, source_system_code, cycle_type_code from $transformDB.vw_abc_load_cycle where source_system_code = 'GWBC' and cycle_type_code = 'STAGE') lc on 1=1 JOIN  $hiveDB.stg_gwbc_bc_transaction trans ON trans.ID = cix.TransactionID WHERE YEAR(trans.TransactionDate) = YEAR(PV_ENDDATE) AND trans.TransactionDate <= PV_ENDDATE GROUP BY LOAD_CYCLE_ID, PV_ENDDATE, source_system_code"

    Holder.log.info(s"SrcQuery: $srcQuery")
    Holder.log.info(s"LakeQuery: $lakeQuery")

    val sourceDF = spark.read.format("jdbc").
      options(Map("url" -> jdbcSqlConnStr, "Driver" -> driver, "dbTable" -> srcQuery)).load.
            withColumn("polstatus",lit(null))
    val lakeDF = spark.sql(lakeQuery)

    val srcDf = sourceDF.
      select(col("extractdate"),col("polstatus"),col("auditentity"),col("auditfrom"),
        col("auditthru"),col("auditresult").as("src_value")).
      withColumn("source_system_cd", lit(src_sstm_cd))
    val dlDf = lakeDF.
      select(col("auditentity"),col("auditresult").as("lake_value"))

    val reconDF = srcDf.join(dlDf, Seq("auditentity")).
      withColumn("recon_status", when(col("src_value")===col("lake_value"),
        lit("success")).otherwise(lit("failed"))).cache

    val saveMode =
      if (spark.catalog.tableExists(s"$reconResultDB.stg_recon"))
      SaveMode.Append else SaveMode.Overwrite
    reconDF.coalesce(1).write.format("parquet").
      partitionBy("source_system_cd").
      mode(saveMode).
      options(Map("path" -> s"$reconResultPath/stg_recon")).
      saveAsTable(s"$reconResultDB.stg_recon")
    reconDF
  }

  def apply( src_sstm_cd: String)(implicit spark: SparkSession) = {
    gwbcRecon(src_sstm_cd)
  }
}
